#!/bin/bash
#
# JPAPI GUI Launcher
# Consolidated SOLID-compliant GUI launcher with automatic interface detection
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
GUI_DIR="$PROJECT_ROOT/src/apps"

# GUI Strategy Interface - follows Strategy pattern
detect_gui_strategy() {
    local preferred_gui="${1:-auto}"
    
    case "$preferred_gui" in
        "swiftdialog"|"swift")
            if command -v swiftDialog &> /dev/null; then
                echo "swiftdialog"
            else
                echo "swiftdialog_unavailable"
            fi
            ;;
        "tkinter"|"tk")
            if python3 -c "import tkinter" 2>/dev/null; then
                echo "tkinter"
            else
                echo "tkinter_unavailable"
            fi
            ;;
        "web"|"browser")
            echo "web"
            ;;
        "auto"|"")
            # Auto-detect best available GUI
            if command -v swiftDialog &> /dev/null; then
                echo "swiftdialog"
            elif python3 -c "import tkinter" 2>/dev/null; then
                echo "tkinter"
            else
                echo "web"
            fi
            ;;
        *)
            echo "unknown"
            ;;
    esac
}

# GUI Strategy Implementations
launch_swiftdialog_gui() {
    echo -e "${GREEN}üöÄ Starting JPAPI Configuration Manager...${NC}"
    echo -e "${BLUE}üì± swiftDialog GUI - Native macOS Interface${NC}"
    echo
    
    local gui_script="$GUI_DIR/launch_swiftdialog.py"
    if [[ ! -f "$gui_script" ]]; then
        echo -e "${RED}‚ùå swiftDialog GUI script not found: $gui_script${NC}"
        return 1
    fi
    
    cd "$PROJECT_ROOT"
    python3 "$gui_script"
}

launch_tkinter_gui() {
    echo -e "${GREEN}üöÄ Starting JPAPI Configuration Manager...${NC}"
    echo -e "${BLUE}üì± Tkinter GUI - Traditional Desktop Interface${NC}"
    echo
    
    local gui_script="$GUI_DIR/launch_config_gui.py"
    if [[ ! -f "$gui_script" ]]; then
        echo -e "${RED}‚ùå Tkinter GUI script not found: $gui_script${NC}"
        return 1
    fi
    
    cd "$PROJECT_ROOT"
    python3 "$gui_script"
}

launch_web_gui() {
    echo -e "${GREEN}üöÄ Starting JPAPI Configuration Manager...${NC}"
    echo -e "${BLUE}üåê Web GUI - Browser-based Interface${NC}"
    echo
    
    local gui_script="$GUI_DIR/launch_gui.py"
    if [[ ! -f "$gui_script" ]]; then
        echo -e "${RED}‚ùå Web GUI script not found: $gui_script${NC}"
        return 1
    fi
    
    cd "$PROJECT_ROOT"
    python3 "$gui_script"
}

# Install swiftDialog if needed
install_swiftdialog() {
    echo -e "${YELLOW}‚ö†Ô∏è  swiftDialog is not installed${NC}"
    echo -e "${YELLOW}   Installing swiftDialog...${NC}"
    
    # Try to install via Homebrew
    if command -v brew &> /dev/null; then
        if brew install swiftDialog; then
            echo -e "${GREEN}‚úÖ swiftDialog installed successfully${NC}"
            return 0
        else
            echo -e "${RED}‚ùå Failed to install swiftDialog via Homebrew${NC}"
        fi
    else
        echo -e "${RED}‚ùå Homebrew not found${NC}"
    fi
    
    echo -e "${YELLOW}   Please install swiftDialog manually:${NC}"
    echo -e "${YELLOW}   1. Download from: https://github.com/bartreardon/swiftDialog/releases${NC}"
    echo -e "${YELLOW}   2. Or install via: brew install swiftDialog${NC}"
    return 1
}

# Show help
show_help() {
    echo -e "${GREEN}üì± JPAPI GUI Launcher${NC}"
    echo -e "${BLUE}Consolidated SOLID-compliant GUI launcher${NC}"
    echo
    echo "üöÄ Usage:"
    echo "   jpapi-gui [--gui <type>] [--help]"
    echo
    echo "üé® Available GUI Types:"
    echo "   --gui swiftdialog    # Native macOS interface (preferred)"
    echo "   --gui tkinter        # Traditional desktop interface"
    echo "   --gui web            # Browser-based interface"
    echo "   --gui auto           # Auto-detect best available (default)"
    echo
    echo "üí° Examples:"
    echo "   jpapi-gui                    # Auto-detect best GUI"
    echo "   jpapi-gui --gui swiftdialog  # Force swiftDialog"
    echo "   jpapi-gui --gui tkinter      # Force Tkinter"
    echo "   jpapi-gui --gui web          # Force web interface"
    echo
    echo "üîß Features:"
    echo "   ‚Ä¢ Automatic GUI detection"
    echo "   ‚Ä¢ Fallback to available interfaces"
    echo "   ‚Ä¢ Native macOS integration"
    echo "   ‚Ä¢ Cross-platform compatibility"
}

# Main function
main() {
    local gui_type="auto"
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --gui)
                gui_type="$2"
                shift 2
                ;;
            --help|-h)
                show_help
                exit 0
                ;;
            *)
                echo -e "${RED}‚ùå Unknown option: $1${NC}"
                show_help
                exit 1
                ;;
        esac
    done
    
    # Check if Python is available
    if ! command -v python3 &> /dev/null; then
        echo -e "${RED}‚ùå Python 3 is not installed or not in PATH${NC}"
        exit 1
    fi
    
    # Detect GUI strategy
    local strategy
    strategy=$(detect_gui_strategy "$gui_type")
    
    case "$strategy" in
        "swiftdialog")
            launch_swiftdialog_gui
            ;;
        "swiftdialog_unavailable")
            echo -e "${YELLOW}‚ö†Ô∏è  swiftDialog not available, trying to install...${NC}"
            if install_swiftdialog; then
                launch_swiftdialog_gui
            else
                echo -e "${YELLOW}   Falling back to alternative GUI...${NC}"
                strategy=$(detect_gui_strategy "auto")
                case "$strategy" in
                    "tkinter")
                        launch_tkinter_gui
                        ;;
                    "web")
                        launch_web_gui
                        ;;
                    *)
                        echo -e "${RED}‚ùå No GUI interfaces available${NC}"
                        exit 1
                        ;;
                esac
            fi
            ;;
        "tkinter")
            launch_tkinter_gui
            ;;
        "tkinter_unavailable")
            echo -e "${YELLOW}‚ö†Ô∏è  Tkinter not available, falling back to web interface${NC}"
            launch_web_gui
            ;;
        "web")
            launch_web_gui
            ;;
        "unknown")
            echo -e "${RED}‚ùå Unknown GUI type: $gui_type${NC}"
            show_help
            exit 1
            ;;
        *)
            echo -e "${RED}‚ùå GUI detection failed${NC}"
            exit 1
            ;;
    esac
}

# Run main function
main "$@"